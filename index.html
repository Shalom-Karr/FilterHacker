<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-900 text-slate-200">
<head>
    <script defer src="https://stats.alltech.dev/script.js" data-website-id="b6174454-66f0-4351-ada4-b2b24d1a1fde"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RevealOS Unfilter Tool</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .terminal {
            background-color: #0d0d0d; border: 1px solid #333; border-radius: 8px;
            padding: 1rem; max-height: 400px; overflow-y: auto; white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace; color: #00ff00; font-size: 0.875rem;
            line-height: 1.25rem; box-shadow: 0 0 10px rgba(0, 255, 0, 0.2); resize: vertical;
        }
        .terminal-message { color: #ddd; }
        .progress-bar-container {
            width: 100%; background-color: #1e293b; border-radius: 9999px;
            overflow: hidden; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.6);
        }
        .progress-bar {
            height: 1.5rem; background-color: #00ff00; border-radius: 9999px;
            transition: width 0.2s ease-out;
            background-image: linear-gradient( 45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%,
                transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%,
                transparent 75%, transparent );
            background-size: 1rem 1rem; position: relative; overflow: hidden;
        }
        .progress-bar::after {
            content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0;
            background: linear-gradient(to right, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.25) 50%, rgba(255, 255, 255, 0) 100%);
            animation: shine 2s infinite;
        }
        @keyframes shine { from { transform: translateX(-100%); } to { transform: translateX(100%); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinner { animation: spin 1.5s linear infinite; }
    </style>
</head>

<body class="flex flex-col items-center justify-center min-h-screen p-4">
    <!-- Welcome Screen -->
    <div id="welcome-screen" class="max-w-xl w-full p-8 bg-slate-800 rounded-2xl shadow-2xl transition-all duration-500 ease-in-out">
        <div class="text-center">
            <h1 class="text-4xl font-bold mb-4 text-emerald-400">RevealOS Unfilter Tool</h1>
            <p class="text-lg mb-6 text-slate-300">Unlock the full potential of your device. Our tool helps restore full internet access and app functionality to filtered, kosher-certified phones by safely modifying system partitions.</p>
        </div>
        <div class="mb-6">
            <label for="phone-select" class="block text-sm font-medium mb-2 text-slate-400">Select Your Phone Model:</label>
            <select id="phone-select" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-xl text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition">
                <option value="Alcatel Go Flip 3/4">Alcatel Go Flip 3/4</option>
                <option value="Alcatel Smartflip">Alcatel Smartflip</option>
                <option value="CAT S22 Flip">CAT S22 Flip</option>
                <option value="EKO F30">EKO F30</option>
                <option value="FIG Flip 2">FIG Flip 2</option>
                <option value="FIG Flip Mini">FIG Flip Mini</option>
                <option value="Jitterbug Flip2 (Lively Flip)">Jitterbug Flip2 (Lively Flip)</option>
                <option value="Kyocera Cadence">Kyocera Cadence</option>
                <option value="Kyocera DuraXV LTE e4610">Kyocera DuraXV LTE e4610</option>
                <option value="Kyocera DuraXV Extreme/Epic">Kyocera DuraXV Extreme/Epic</option>
                <option value="LG Classic">LG Classic</option>
                <option value="LG Exalt">LG Exalt</option>
                <option value="Nokia 2720 V Flip">Nokia 2720 V Flip</option>
                <option value="Nokia 2780 Flip">Nokia 2780 Flip</option>
                <option value="Orbic Journey V">Orbic Journey V</option>
                <option value="Qin F21">Qin F21</option>
                <option value="Sunbeam F1 Orchid/Dandelion">Sunbeam F1 Orchid/Dandelion</option>
                <option value="TCL Flip/Flip Pro">TCL Flip/Flip Pro</option>
                <option value="Wonder Phone">Wonder Phone</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <p class="text-sm text-slate-400 mb-2 text-center">Ensure you have the right cable for your phone and push start:</p>
        <button id="continue-btn" class="w-full p-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl transition duration-300 transform hover:scale-105">Start</button>
        <div class="mt-6 text-center"><button id="how-it-works-btn" class="text-sm text-slate-500 hover:text-slate-400 transition">How this works</button></div>
    </div>

    <!-- Modals -->
    <div id="how-it-works-modal" class="fixed inset-0 z-50 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden">
        <div class="bg-slate-800 p-8 rounded-2xl max-w-2xl w-full shadow-2xl relative">
            <button id="close-works-modal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-200 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 class="text-2xl font-bold mb-4 text-emerald-400">How RevealOS™ Works</h2>
            <div class="text-slate-300 space-y-4 text-sm sm:text-base">
                <p>Our breakthrough RevealOS™ technology targets the hidden partition structures used by kosher phone manufacturers to restrict functionality. These devices use modified Android builds with deep system-level blocks.</p>
                <p>When you connect your kosher phone, our system accesses the device through ADB debugging protocols, even when debugging appears disabled. We exploit a bootloader vulnerability that exists in most kosher phone firmware.</p>
                <h3 class="font-semibold text-slate-200">The process works by:</h3>
                <ul class="list-decimal list-inside space-y-2">
                    <li><strong class="text-emerald-300">Partition Discovery</strong> - Maps hidden system partitions containing restriction databases.</li>
                    <li><strong class="text-emerald-300">Lockdown Bypass</strong> - Injects custom recovery signatures to bypass secure boot.</li>
                    <li><strong class="text-emerald-300">Restriction Database Modification</strong> - Overwrites app blacklists, browser restrictions, and connectivity blocks.</li>
                    <li><strong class="text-emerald-300">System Framework Patching</strong> - Removes hardcoded limitations from Android framework.</li>
                    <li><strong class="text-emerald-300">OTA Prevention</strong> - Blocks future manufacturer updates that would restore restrictions.</li>
                </ul>
                <p>The 48-hour window allows the modified system to fully integrate and rebuild its cache files. During this time, restrictions gradually disappear as the phone's security manager rebuilds its policy database with our unrestricted templates.</p>
                <p>This process is completely reversible and leaves no permanent traces in the device's NVRAM.</p>
            </div>
        </div>
    </div>

    <!-- Connection Modal -->
    <div id="connection-modal" class="fixed inset-0 z-50 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden">
        <div class="bg-slate-800 p-8 rounded-2xl max-w-sm w-full text-center shadow-2xl">
            <h2 id="connection-modal-title" class="text-2xl font-bold mb-4 text-emerald-400">Waiting for Phone</h2>
            <p id="connection-modal-message" class="mb-6 text-slate-300">Please connect your phone to the computer with a USB cable.</p>

            <!-- Initial Connection State -->
            <div id="initial-connection-state" class="flex items-center justify-center mb-6"><div class="w-16 h-16 rounded-full border-4 border-slate-600 border-t-emerald-500 spinner"></div></div>

            <!-- WebUSB Detection Results -->
            <div id="webusb-success-state" class="hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-green-500" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-3-3a1 1 0 011.414-1.414L9 11.586 15.293 5.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                <p class="text-lg font-semibold text-slate-300 mb-6">WebUSB Connection Successful!</p>
                <p class="text-md text-slate-400 mb-6">USB Debugging appears to be enabled and the device is ready.</p>
            </div>

            <div id="webusb-failure-state" class="hidden">
                <p class="mb-4 text-slate-300">We couldn't detect your device using WebUSB. This often means USB Debugging is disabled.</p>
                <button id="filter-blocking-btn" class="w-full p-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl transition duration-300 mb-4">Filter Blocking? Press Here.</button>
            </div>

            <!-- Alternative Connection Steps (Hidden by Default) -->
            <div id="alternative-connection-steps" class="hidden">
                <h3 class="text-xl font-semibold mb-3 text-emerald-400">Troubleshooting Steps</h3>
                <p class="mb-4 text-slate-400 text-sm">If the above didn't work, follow these steps:</p>
                <ol class="list-decimal list-inside text-left text-slate-400 text-sm space-y-2 mb-6">
                    <li>Disconnect your phone from the computer.</li>
                    <li>Press and hold both **Volume Up** and **Volume Down** buttons simultaneously.</li>
                    <li>While holding the buttons, connect your phone to the computer via USB.</li>
                    <li>Continue holding for at least 30 seconds.</li>
                </ol>
                <p class="mb-4 text-slate-400 text-sm">This might force your device into a special connection mode.</p>
            </div>

            <!-- Final Confirmation Button -->
            <button id="connected-btn" class="w-full p-3 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl transition duration-300 hidden">I've Connected, Start Process</button>
        </div>
    </div>

    <!-- Disconnect Modal -->
    <div id="disconnect-modal" class="fixed inset-0 z-50 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden">
        <div class="bg-slate-800 p-8 rounded-2xl max-w-sm w-full text-center shadow-2xl">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <h2 class="text-2xl font-bold mb-4 text-red-400">Connection Lost</h2>
            <p class="mb-6 text-slate-300">The device was unexpectedly disconnected. Please check your connection and start the process again.</p>
            <button id="try-again-btn" class="w-full p-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl transition duration-300">Try Again</button>
        </div>
    </div>

    <!-- IMEI and Build Number Screen -->
    <div id="imei-screen" class="max-w-xl w-full p-8 bg-slate-800 rounded-2xl shadow-2xl hidden transition-all duration-500 ease-in-out">
        <div class="text-center">
            <h2 class="text-3xl font-bold mb-4 text-emerald-400">Device Information</h2>
            <p class="mb-6 text-slate-300">To continue, we need to verify your device's unique identifiers.</p>
        </div>
        <div id="imei-section" class="mb-6">
            <p class="mb-4 text-slate-400">Please enter your IMEI number. You can find this by dialing <span class="bg-slate-700 text-emerald-400 px-2 py-1 rounded-md font-mono">*#06#</span> on your phone's keypad.</p>
            <input id="imei-input" type="text" placeholder="Enter IMEI" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-xl text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-colors">
            <p id="imei-error" class="text-red-400 text-sm mt-2 hidden">Please enter a valid, 14+ digit numeric IMEI.</p>
        </div>
        <div id="mac-address-section" class="mb-6 hidden">
            <p class="mb-4 text-slate-400">Next, enter your Wi-Fi MAC address. This is a critical step for restoring full internet access. Find it in <span class="font-semibold text-slate-300">Settings > About Phone > Status</span>.</p>
            <input id="mac-address-input" type="text" placeholder="e.g., A1:B2:C3:D4:E5:F6" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-xl text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-colors">
            <p id="mac-error" class="text-red-400 text-sm mt-2 hidden">Please enter a valid MAC address format (e.g., XX:XX:XX:XX:XX:XX).</p>
        </div>
        <div id="build-number-section" class="mb-6 hidden">
            <p class="mb-4 text-slate-400">Finally, please enter your device's build number. It can also be found in your phone's 'About Phone' settings.</p>
            <input id="build-number-input" type="text" placeholder="Enter Build Number" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-xl text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500">
        </div>
        <button id="start-process-btn" class="w-full p-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-xl transition duration-300 transform hover:scale-105">Start Unfiltering Process</button>
    </div>

    <!-- Processing and Completion Screens -->
    <div id="processing-screen" class="max-w-3xl w-full p-8 bg-slate-800 rounded-2xl shadow-2xl hidden transition-all duration-500 ease-in-out">
        <div class="text-center">
            <h2 class="text-3xl font-bold mb-4 text-emerald-400">Processing...</h2>
            <p class="mb-6 text-yellow-300 font-semibold">This process may take up to 5 minutes. Please ensure your phone remains connected.</p>
        </div>
        <div class="flex items-center justify-center mb-6"><div class="w-16 h-16 rounded-full border-4 border-slate-600 border-t-emerald-500 spinner"></div></div>
        <div class="space-y-4 mb-8">
            <div class="space-y-2"><p class="text-sm font-semibold text-slate-400">Accessing Device Partition...</p><div class="progress-bar-container"><div id="progress-bar-1" class="progress-bar" style="width: 0%;"></div></div></div>
            <div class="space-y-2"><p class="text-sm font-semibold text-slate-400">Patching System Framework...</p><div class="progress-bar-container"><div id="progress-bar-2" class="progress-bar" style="width: 0%;"></div></div></div>
            <div class="space-y-2"><p class="text-sm font-semibold text-slate-400">Modifying Restriction Database...</p><div class="progress-bar-container"><div id="progress-bar-3" class="progress-bar" style="width: 0%;"></div></div></div>
        </div>
        <div class="terminal"><div id="terminal-output"></div><span class="text-emerald-400 animate-pulse terminal-cursor">&#9608;</span></div>
    </div>
    <div id="completion-screen" class="max-w-md w-full p-8 bg-slate-800 rounded-2xl shadow-2xl text-center hidden transition-all duration-500 ease-in-out">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mx-auto mb-4 text-emerald-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
        <h2 class="text-3xl font-bold mb-4 text-emerald-400">Process Complete!</h2>
        <p class="text-lg text-slate-300 mb-4">Please restart your phone. Your device will be unfiltered within 48 hours as the changes integrate.</p>
        <p class="text-lg text-yellow-300 font-semibold">After restarting, please turn on <strong>Airplane Mode for one hour</strong> to allow the new system policies to finalize without interruption.</p>
    </div>

    <script>
        const UNFILTER_DURATION = 300000; // 5 minutes
        const IP_API_URL = 'https://api.ipify.org?format=json';

        // --- Screen Elements ---
        const welcomeScreen = document.getElementById('welcome-screen');
        const connectionModal = document.getElementById('connection-modal');
        const disconnectModal = document.getElementById('disconnect-modal');
        const imeiScreen = document.getElementById('imei-screen');
        const processingScreen = document.getElementById('processing-screen');
        const completionScreen = document.getElementById('completion-screen');
        const howItWorksModal = document.getElementById('how-it-works-modal');

        // --- Button Elements ---
        const continueBtn = document.getElementById('continue-btn');
        const connectedBtn = document.getElementById('connected-btn');
        const tryAgainBtn = document.getElementById('try-again-btn');
        const startProcessBtn = document.getElementById('start-process-btn');
        const howItWorksBtn = document.getElementById('how-it-works-btn');
        const closeWorksModalBtn = document.getElementById('close-works-modal');
        const filterBlockingBtn = document.getElementById('filter-blocking-btn');

        // --- Input Elements ---
        const imeiInput = document.getElementById('imei-input');
        const imeiError = document.getElementById('imei-error');
        const macAddressSection = document.getElementById('mac-address-section');
        const macAddressInput = document.getElementById('mac-address-input');
        const macError = document.getElementById('mac-error');
        const buildNumberSection = document.getElementById('build-number-section');
        const buildNumberInput = document.getElementById('build-number-input'); // Added for consistency

        // --- Connection Modal Dynamic Elements ---
        const connectionModalTitle = document.getElementById('connection-modal-title');
        const connectionModalMessage = document.getElementById('connection-modal-message');
        const initialConnectionState = document.getElementById('initial-connection-state');
        const webusbSuccessState = document.getElementById('webusb-success-state');
        const webusbFailureState = document.getElementById('webusb-failure-state');
        const alternativeConnectionSteps = document.getElementById('alternative-connection-steps');

        // --- Processing Screen Elements ---
        const terminalOutput = document.getElementById('terminal-output');
        const progressBars = [
            document.getElementById('progress-bar-1'),
            document.getElementById('progress-bar-2'),
            document.getElementById('progress-bar-3')
        ];

        // --- Terminal Messages for Processing ---
        const terminalMessages = [
            { text: "Establishing secure connection...", delay: 0 }, { text: "Connection established.", delay: 0 }, { text: "Running exploit on bootloader...", delay: 0 },
            { text: "Validating network identifiers (IMEI & MAC)...", delay: 5000 }, { text: "Querying device properties...", delay: 3000 },
            { text: "Reading SoC identification...", delay: 4000 }, { text: "Verifying USB driver stack integrity...", delay: 2000 },
            { text: "Enumerating ADB device endpoints...", delay: 3000 }, { text: "Authenticating with device... RSA key fingerprint accepted.", delay: 4000 },
            { text: "Requesting elevated privileges via shell...", delay: 6000 }, { text: "Checking SELinux status... (Current state: Enforcing)", delay: 2000 },
            { text: "Bootloader vulnerability found on selected device model.", delay: 4000 }, { text: "Acquiring root shell through kernel race condition...", delay: 8000 },
            { text: "Creating temporary backup of bootloader partition...", delay: 7000 }, { text: "Disabling dm-verity and Android Verified Boot...", delay: 9000 },
            { text: "Injecting payload into initramfs...", delay: 6000 }, { text: "Temporarily loading custom permissive SELinux policy...", delay: 5000 },
            { text: "Patching kernel in-memory to bypass security checks...", delay: 10000 }, { text: "Accessing hidden partition structures...", delay: 5000 },
            { text: "Remounting /system and /vendor partitions as read/write...", delay: 8000 }, { text: "Partition map discovered. Scanning for restriction databases...", delay: 9000 },
            { text: "Analyzing /system partition filesystem (ext4)...", delay: 4000 }, { text: "Performing checksum verification on critical system binaries...", delay: 6000 },
            { text: "Restriction database located at /dev/block/by-name/persist/policy_db", delay: 2000 }, { text: "Backing up original NVRAM values to temporary storage...", delay: 5000 },
            { text: "Bypassing secure boot with custom recovery signature...", delay: 12000 }, { text: "Decompiling services.jar for analysis...", delay: 10000 },
            { text: "Patching ConnectivityService to remove hardcoded restrictions...", delay: 8000 }, { text: "Modifying PackageManagerService lockdown policies...", delay: 8000 },
            { text: "Clearing app restriction lists from Settings Provider database...", delay: 7000 }, { text: "Neutralizing device administration enforcement policies...", delay: 6000 },
            { text: "Re-provisioning MAC address for network access...", delay: 8000 }, { text: "Resetting APN settings to default AOSP configuration...", delay: 5000 },
            { text: "Unblocking restricted network ports via iptables modification...", delay: 6000 }, { text: "Flushing DNS cache and captive portal checks...", delay: 4000 },
            { text: "Injection complete. Overwriting app blacklists and connectivity blocks...", delay: 9000 }, { text: "Writing new policy file...", delay: 8000 },
            { text: "Patching system framework...", delay: 10000 }, { text: "Removing hardcoded limitations from system services...", delay: 9000 },
            { text: "Enabling OTA prevention to block future restriction updates...", delay: 7000 }, { text: "Syncing new policy with security manager...", delay: 8000 },
            { text: "Wiping Dalvik/ART cache to force app recompilation...", delay: 9000 }, { text: "Cleaning temporary files and logs...", delay: 5000 },
            { text: "Removing exploit remnants from /data/local/tmp...", delay: 4000 }, { text: "Syncing all filesystem writes to persistent storage...", delay: 7000 },
            { text: "Preparing device for a clean reboot cycle...", delay: 3000 }
        ];

        // --- Utility Functions ---
        const wait = ms => new Promise(resolve => setTimeout(resolve, ms));

        function simulateTyping(message) {
            return new Promise(resolve => {
                const now = new Date();
                const timestamp = `[${now.toLocaleTimeString()}] > `;
                const lineContainer = document.createElement('div');
                const span = document.createElement('span');
                span.className = 'terminal-message';
                span.textContent = timestamp;
                lineContainer.appendChild(span);
                terminalOutput.appendChild(lineContainer);
                let charIndex = 0;
                const typeInterval = setInterval(() => {
                    if (charIndex < message.length) {
                        span.textContent += message[charIndex];
                        charIndex++;
                        terminalOutput.scrollTop = terminalOutput.scrollHeight;
                    } else {
                        clearInterval(typeInterval);
                        resolve();
                    }
                }, 15); // Typing speed
            });
        }

        // --- Connection Modal Logic ---
        let webusbSupported = false;
        let isWebUSBConnected = false; // True if WebUSB connection was successful

        function resetConnectionModalUI() {
            connectionModalTitle.textContent = "Waiting for Phone";
            connectionModalMessage.textContent = "Please connect your phone to the computer with a USB cable.";
            initialConnectionState.classList.remove('hidden');
            webusbSuccessState.classList.add('hidden');
            webusbFailureState.classList.add('hidden');
            alternativeConnectionSteps.classList.add('hidden');
            filterBlockingBtn.classList.remove('hidden'); // Ensure it's visible for failure state
            connectedBtn.classList.add('hidden'); // Hide the final button until ready
        }

        function checkWebUSBSupport() {
            if ('usb' in navigator) {
                console.log("WebUSB is supported in this browser.");
                webusbSupported = true;
            } else {
                console.log("WebUSB is NOT supported in this browser.");
                webusbSupported = false;
            }
        }

        async function attemptWebUSBConnection() {
            if (!webusbSupported) {
                console.log("Cannot attempt WebUSB: Not supported.");
                showWebUSBFailure(); // Directly show failure if not supported
                return;
            }

            try {
                // Prompt user to select a device
                const device = await navigator.usb.requestDevice({ filters: [] }); 

                console.log("Device selected:", device);
                
                // Basic check for ADB-like interfaces. This is a simplification.
                let adbInterfaceFound = false;
                let adbInterfaceNumber = -1;

                if (device.configuration) {
                    for (const iface of device.configuration.interfaces) {
                        // Common classes that might indicate ADB capability
                        if (iface.interfaceClass === 255 || iface.interfaceClass === 3 || iface.interfaceClass === 10) {
                            adbInterfaceFound = true;
                            adbInterfaceNumber = iface.interfaceNumber;
                            break; // Found a potential interface
                        }
                    }
                }

                if (!adbInterfaceFound) {
                    console.log("No suitable ADB-like interface found on the device.");
                    connectionModalMessage.textContent = "Could not find a compatible interface on the device. Ensure USB Debugging is enabled.";
                    showWebUSBFailure(); // Show failure UI
                    return;
                }

                try {
                    await device.open();
                    // Select the first configuration (usually the only one, or the default)
                    if (device.configuration === null) {
                        await device.selectConfiguration(1);
                    }
                    
                    await device.claimInterface(adbInterfaceNumber);
                    console.log("Successfully claimed ADB interface.");
                    isWebUSBConnected = true; 
                    showWebUSBSccess(); // Show success UI, including the next button

                } catch (e) {
                    console.error("Error claiming WebUSB interface:", e);
                    if (e.message.includes("Busy")) {
                        connectionModalMessage.textContent = "Device is busy or already in use. Please try again.";
                    } else if (e.message.includes("permission denied")) {
                        connectionModalMessage.textContent = "Permission denied for this interface. Ensure USB Debugging is enabled and authorized.";
                    } else {
                        connectionModalMessage.textContent = "Could not claim device interface. Is USB Debugging enabled?";
                    }
                    showWebUSBFailure(); // Show failure UI
                }

            } catch (e) {
                console.error("Error during WebUSB device request:", e);
                if (e.message.includes("permission denied")) {
                     connectionModalMessage.textContent = "Permission denied. Please authorize your browser for USB access.";
                } else if (e.message.includes("no device selected")) {
                    connectionModalMessage.textContent = "No device selected. Please select your phone.";
                    // --- MODIFICATION START ---
                    // If no device is selected, we still want to enable the option to proceed
                    showWebUSBFailure(); // Show failure UI
                    // --- MODIFICATION END ---
                } else {
                    connectionModalMessage.textContent = "Could not detect any USB devices. Ensure your phone is connected.";
                    // --- MODIFICATION START ---
                    // If any other WebUSB error occurs (e.g., device not found), also show failure UI
                    showWebUSBFailure(); // Show failure UI
                    // --- MODIFICATION END ---
                }
            }
        }

        function showWebUSBSccess() {
            initialConnectionState.classList.add('hidden');
            webusbSuccessState.classList.remove('hidden');
            webusbFailureState.classList.add('hidden');
            alternativeConnectionSteps.classList.add('hidden');
            filterBlockingBtn.classList.add('hidden'); // Hide troubleshooting button on success
            connectedBtn.classList.remove('hidden'); // Make the "proceed" button visible
            connectionModalTitle.textContent = "Device Ready";
        }

        function showWebUSBFailure() {
            initialConnectionState.classList.add('hidden');
            webusbSuccessState.classList.add('hidden');
            webusbFailureState.classList.remove('hidden');
            // Alternative steps are hidden until filterBlockingBtn is clicked
            filterBlockingBtn.classList.remove('hidden'); // Always show this in failure state to reveal next button
            // We will show connectedBtn after the user engages with the failure state
            connectionModalTitle.textContent = "Connection Issue";
        }

        // --- Event Listeners ---
        continueBtn.addEventListener('click', () => {
            welcomeScreen.classList.add('hidden');
            resetConnectionModalUI(); // Reset UI on show
            connectionModal.classList.remove('hidden');
            checkWebUSBSupport();
            if (webusbSupported) {
                attemptWebUSBConnection();
            } else {
                // If WebUSB is not supported, directly show the failure state
                showWebUSBFailure();
            }
        });

        filterBlockingBtn.addEventListener('click', () => {
            alternativeConnectionSteps.classList.remove('hidden');
            filterBlockingBtn.classList.add('hidden'); 
            connectedBtn.classList.remove('hidden'); // Make the "proceed" button visible after showing steps
            connectionModalTitle.textContent = "Connection Issue"; // Update title again if it was changed by failure
        });

        connectedBtn.addEventListener('click', () => {
            // This button now proceeds regardless of actual WebUSB connection success,
            // as per your instruction to move on even if no device is connected.
            // The visibility logic ensures it's shown when the user is ready to proceed.
            
            connectionModal.classList.add('hidden');
            imeiScreen.classList.remove('hidden');
            setTimeout(() => { // Add a delay for visual appeal before revealing the next sections
                macAddressSection.classList.remove('hidden');
                buildNumberSection.classList.remove('hidden');
            }, 500); // Short delay, adjust as needed for visual flow
        });

        tryAgainBtn.addEventListener('click', () => { location.reload(); });

        startProcessBtn.addEventListener('click', () => {
            terminalOutput.innerHTML = '';
            progressBars.forEach(bar => bar.style.width = '0%');

            const imeiValue = imeiInput.value.trim();
            const macValue = macAddressInput.value.trim();
            const macRegex = /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/;

            const isImeiValid = imeiValue !== '' && !isNaN(imeiValue) && imeiValue.length >= 14;
            const isMacValid = macRegex.test(macValue);
            
            setInputState(imeiInput, imeiError, isImeiValid);
            setInputState(macAddressInput, macError, isMacValid);

            if (!isImeiValid) {
                imeiInput.focus();
                return;
            }
            if (!isMacValid) {
                macAddressInput.focus();
                return;
            }

            imeiScreen.classList.add('hidden');
            processingScreen.classList.remove('hidden');
            runProcess();
        });

        howItWorksBtn.addEventListener('click', () => { howItWorksModal.classList.remove('hidden'); });
        closeWorksModalBtn.addEventListener('click', () => { howItWorksModal.classList.add('hidden'); });

        // Close modals by clicking outside
        [howItWorksModal, connectionModal, disconnectModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        });

        // --- Helper Function for Input Validation Styling ---
        function setInputState(input, errorElement, isValid) {
            const errorClasses = ['border-red-500', 'focus:ring-red-500'];
            const defaultClasses = ['border-slate-600', 'focus:ring-emerald-500'];
            if (isValid) {
                input.classList.remove(...errorClasses);
                input.classList.add(...defaultClasses);
                errorElement.classList.add('hidden');
            } else {
                input.classList.remove(...defaultClasses);
                input.classList.add(...errorClasses);
                errorElement.classList.remove('hidden');
            }
        }

        // --- Processing Logic ---
        async function runProcess() {
            // Initial terminal messages before IP check
            await simulateTyping(terminalMessages[0].text);
            await wait(1500);
            await simulateTyping(terminalMessages[1].text);
            await wait(2000);
            await simulateTyping(terminalMessages[2].text);
            await wait(500);

            // --- IP Check ---
            try {
                const response = await fetch(IP_API_URL);
                if (!response.ok) throw new Error('IP API failed');
                const data = await response.json();
                const userIp = data.ip;

                let seenIPs = JSON.parse(localStorage.getItem('seenIPs')) || [];
                if (!seenIPs.includes(userIp)) {
                    console.log("New IP detected:", userIp);
                    // If IP is new, show disconnect modal (as per the plan's security step)
                    processingScreen.classList.add('hidden');
                    disconnectModal.classList.remove('hidden');
                    return; // Stop processing here until user retries
                } else {
                    console.log("Returning IP detected:", userIp);
                }
            } catch (error) {
                console.error("IP check failed, proceeding as a returning user.", error);
                // If IP check fails, we still proceed to animation as if it's a returning user
            }

            // --- Start Animation Loop if IP check passed or was skipped ---
            startMainAnimationLoop();
        }

        function startMainAnimationLoop() {
            const messagesToRun = terminalMessages.slice(3); // Skip the initial messages
            const startTime = Date.now();
            let currentMessageIndex = 0;
            let cumulativeTime = 0;
            
            // Map messages to their scheduled display times
            const timedMessages = messagesToRun.map(msg => {
                const messageDuration = msg.delay; // Using delay as duration for simplicity
                const scheduledTime = cumulativeTime;
                cumulativeTime += messageDuration;
                return { ...msg, triggerTime: scheduledTime, isDisplayed: false };
            });
            const totalMessageDuration = cumulativeTime; // Total simulated time for all messages

            function updateFrame() {
                const elapsedTime = Date.now() - startTime;

                // Update progress bars based on overall process duration
                // Distribute progress across bars (e.g., 1/3 each)
                progressBars.forEach((bar, index) => {
                    // Calculate progress for this segment (0-100%)
                    const segmentProgress = Math.min(elapsedTime / UNFILTER_DURATION * 100, 100);
                    // Ensure each bar fills sequentially and caps at 100% within its own segment's responsibility
                    const barTarget = Math.min(Math.max(0, (segmentProgress - (index * 33.3)) * 3), 100);
                    bar.style.width = `${barTarget}%`;
                });

                // Display timed terminal messages
                if (currentMessageIndex < timedMessages.length) {
                    // Scale the elapsed time against the total simulated message duration
                    const scaledElapsedTime = (elapsedTime / UNFILTER_DURATION) * totalMessageDuration;
                    const message = timedMessages[currentMessageIndex];
                    
                    if (scaledElapsedTime >= message.triggerTime && !message.isDisplayed) {
                        message.isDisplayed = true;
                        simulateTyping(message.text).then(() => {
                            currentMessageIndex++;
                        });
                    }
                }

                // Check if process is complete
                if (elapsedTime >= UNFILTER_DURATION) {
                    progressBars.forEach(bar => bar.style.width = '100%'); // Ensure bars are full
                    setTimeout(() => {
                        processingScreen.classList.add('hidden');
                        completionScreen.classList.remove('hidden');
                    }, 1500); // Short delay before showing completion
                } else {
                    requestAnimationFrame(updateFrame); // Continue the animation loop
                }
            }
            requestAnimationFrame(updateFrame); // Start the animation loop
        }
    </script>
</body>
</html>
